#!/bin/bash

N=10

OPTIND=1  
HDFS_INPUT_PATH="/ccc/input/"

while getopts "n:i:" opt; do
  case $opt in
    n)
      N=$OPTARG
      ;;
    i)
      HDFS_INPUT_PATH=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND-1))
[ "$1" = "--" ] && shift

NAME=$1
HDFS_OUTPUT_PATH="/ccc/$NAME/"
LOGFILE="logs/$NAME-`date +"%Y%m%d%H%M%S"`.log"

if [[ -z $NAME ]]; then
    echo "No task given"
    exit 1
fi

if [[ -z $HDFS_INPUT_PATH ]]; then
    echo "No input path given"
    exit 1
fi

echo "Input path: $HDFS_INPUT_PATH"
echo "Output path: $HDFS_OUTPUT_PATH"
echo "Logfile: $LOGFILE"

$HADOOP_INSTALL/bin/hdfs dfs -mkdir -p $HDFS_OUTPUT_PATH || true 
/usr/bin/nohup $HADOOP_INSTALL/bin/hadoop jar jars/$NAME.jar task.$NAME -D N=$N $HDFS_INPUT_PATH $HDFS_OUTPUT_PATH > $LOGFILE 2>&1 &
